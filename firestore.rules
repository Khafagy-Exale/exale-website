rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Basic users doc: owner/admin role enforcement
    match /users/{userId} {
      allow create: if request.auth != null; // allow signup
      allow read: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin']);
      allow update: if request.auth != null && (
        // Users can update their own profile fields
        request.auth.uid == userId && !(request.resource.data.role != resource.data.role)
        // or owner/admin can update anything
        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin']
      );
      // Only Owner can change roles
      allow write: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner');
    }

    match /tasks/{taskId} {
      allow create: if request.auth != null;

      // Reading serialNumber is restricted: only owner/admin or the assigned user may read it.
      allow get: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin']
        || resource.data.assigneeId == request.auth.uid
      );

      // For list queries, allow read but hide serialNumber by requiring client to only read fields other than serialNumber implicitly.
      allow list: if request.auth != null;

      // Updates allowed by assignee or owner/admin. Serial number cannot be altered. Deletions only owner/admin.
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin']
        || resource.data.assigneeId == request.auth.uid
      ) && request.resource.data.serialNumber == resource.data.serialNumber;

      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin'];
    }

    match /schedules/{eventId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;

      // Prevent moving/resizing deadlines unless owner/admin
      allow update: if request.auth != null && (
        // If existing data has isDeadline==true, only owner/admin can change start/end
        (resource.data.isDeadline == true) ? (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin']) : true
      );

      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin'];
    }

    match /shortcuts/{id} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['owner','admin'] || request.auth.uid == resource.data.ownerId
      );
    }

    match /{document=**} { allow read: if false; allow write: if false; }
  }
}